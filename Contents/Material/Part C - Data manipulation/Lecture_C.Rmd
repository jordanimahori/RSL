---
title: 'Data Manipulation'
author: "Statistical Programming with R"
date: ""
output:
  ioslides_presentation:
    fig_height: 5
    fig_width: 8
    logo: logo_en.png
    transition: faster
    smaller: true
  beamer_presentation: default
---


## This lecture

*Date Manipulation*

- Filtering rows
- Selecting columns
- Creating calculated columns
- Sorting observations
- Renaming variables
- Pipes

<!-- - Tidy data -->


## New packages we use
```{r warning=FALSE, message=FALSE}
library(readr)      # reading/writing tabular data
library(readxl)     # reading/writing data from Excel files
library(dplyr)      # data manipulation
library(magrittr)   # for pipes
```


## Reading Data

- We use different packages to read different types of data. 
- For example, we use `read_csv()` to read a csv, and `read_excel()` for an xlsx file. 
```{r}
asycuda <- read_csv("~/Projects/NRA/RSL/data/asycuda_example.csv", 
             guess_max = 100000)
```

## Quickly Viewing Data

```{r}
head(asycuda, n = 4)

str(asycuda)          # Describes the structure of the data.frame
```


## Filtering in Base R using Indexes

```{r}
imports <- asycuda[asycuda$DECTYPE == "IM4", ]
head(imports)
```


## Filtering in Base R using Indexes
```{r}
high_cif <- asycuda[asycuda$CIFVALUE > 2500000000, ]
head(high_cif)
```


## Filtering in Base R using the 'subset' Function
```{r}
high_cif2 <- subset(asycuda, CIFVALUE > 2500000000)
dim(high_cif2)
head(high_cif2)
```


## Filtering using `dplyr`
```{r}
filter(asycuda, DECTYPE == "IM4", CIFVALUE > 2500000000)
```


# Sorting 

## Sorting in Base R

```{r}
sorted_asycuda <- asycuda[order(asycuda$CIFVALUE), ]
head(sorted_asycuda)
```

## Sorting using `dplyr` 

```{r}
sorted_asycuda2 <- arrange(asycuda, CIFVALUE)
head(sorted_asycuda2)
```


# Selecting Variables


## Selecting in Base R using Subsetting

R comes with the [] operator, which can be used to select elements in vectors and lists, and columns rows from data.frames or matrices.

```{r}
asycuda[4,]    # To select fourth row
head(asycuda[, 3])   # To select the third column
```


## Selecting in Base R using Subsetting (cont.)
```{r}
asycuda[4, 3]  # To select the element in row 4, column 3
```


## Selecting in Base R using Subsetting

- It is possible to select by using names, too:
`my_df[c("rowname 1", "rowname 2"), c("columnname 1", "columnname 2", "columnname 3")]`

will return a subset of the dataframe `my_df` consisting of the intersection of the 2 rows named `rowname 1` and `rowname 2` and the 3 columns named `columnname 1`, `columnname 2` and `columnname 3`.

- which dimensions would that subset have?


## Selecting using dplyr

```{r}
select(imports, OFFICECODE, CIFVALUE)
```

# Pipes

## This is a pipe:

```{r}
read_csv("~/Projects/NRA/RSL/data/asycuda_example.csv", 
                     guess_max = 100000, show_col_types = FALSE) %>%
  head()
```

It effectively replaces:
`head(read_excel("~/Projects/NRA/RSL/data/asycuda_example.csv"))`.


## Why are pipes useful?
Let's assume that we want to load data, filter cases, select columns and modify a variable's values. Without a pipe, this would look like
```{r}
asycuda <- read_excel("~/Projects/NRA/RSL/data/Import Export May 2022.xls", 
                       guess_max = 100000)
asycuda2 <- filter(asycuda, DECTYPE == "IM4")
asycuda3 <- select(asycuda2, OFFICECODE, DECTYPE, CIFVALUE)
asycuda_example <- mutate(asycuda3, 
                          CIFVALUE = CIFVALUE*runif(n=length(CIFVALUE), min=0.5, max=1.5))

head(asycuda_example)
```

With the pipe:
```{r}
asycuda_example <-
  asycuda %>%
  filter(DECTYPE == "IM4" | DECTYPE == "EX1") %>%
  select(OFFICECODE, DECTYPE, CIFVALUE) %>%
  arrange(desc(CIFVALUE)) %>%
  mutate(CIFVALUE = CIFVALUE*runif(n=length(CIFVALUE), min=0.5, max=1.5))

head(asycuda_example)
```

## With pipes
Your code becomes more readable:

- data operations are structured from left-to-right and not from in-to-out
- nested function calls are avoided
- local variables and copied objects are avoided
- easy to add steps in the sequence

## What do pipes do:

- `f(x)` becomes `x %>% f()`
```{r}
rnorm(10) %>% mean()
```
- `f(x, y)` becomes `x %>% f(y)` 
```{r}
asycuda %>% filter(OFFICECODE == "SLFQE")
```


## What do pipes do: 

- `h(g(f(x)))` becomes `x %>% f %>% g %>% h` 
```{r}
asycuda %>% filter(OFFICECODE == "SLFQE") %>% select(-DECTYPE)
```


## The role of `.` in a pipe
In `a %>% b(arg1, arg2, arg3)`, `a` will become `arg1`. With `.` we can change this.
```{r error=TRUE}
set.seed(123)

1:5 %>%
  mean() %>%
  rnorm(10)
```
VS
```{r}
set.seed(123)
1:5 %>%
  mean() %>%
  rnorm(n = 10, mean = .)
```
The `.` can be used as a placeholder in the pipe.


# Practical 








